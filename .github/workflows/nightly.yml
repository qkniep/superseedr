name: Nightly Fuzzing

on:
  schedule:
    # Runs at 02:00 UTC every day
    - cron: '0 2 * * *'
  # Allows you to click "Run workflow" manually in GitHub Actions UI
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  PROPTEST_CASES: 1000000 # 1 Million cases

jobs:
  deep_fuzz:
    name: Fuzz (Release)
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Safety net to prevent hanging jobs costing $$
    
    steps:
    - uses: actions/checkout@v4

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        # Distinct key for RELEASE artifacts so we don't mix with Debug
        key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

    - name: Build (Release)
      # Compiling in release takes longer, but makes the 1M tests run 10x faster
      run: cargo build --verbose --release

    - name: Run Deep Tests
      # If this fails, check the logs for "seed: <number>" to reproduce locally
      run: cargo test --verbose --release
